{"version":3,"file":"Channel.js","sources":["../../src/channel/Channel.js"],"sourcesContent":["// SPDX-License-Identifier: Apache-2.0\n\nimport * as HieroProto from \"@hashgraph/proto\";\nimport * as utf8 from \"../encoding/utf8.js\";\n\nconst { proto } = HieroProto;\n\n/**\n * @internal\n * @abstract\n */\nexport default class Channel {\n    /**\n     * @protected\n     */\n    constructor() {\n        /**\n         * @protected\n         * @type {?HieroProto.proto.CryptoService}\n         */\n        this._crypto = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.SmartContractService}\n         */\n        this._smartContract = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.FileService}\n         */\n        this._file = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.ConsensusService}\n         */\n        this._consensus = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.FreezeService}\n         */\n        this._freeze = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.NetworkService}\n         */\n        this._network = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.TokenService}\n         */\n        this._token = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.ScheduleService}\n         */\n        this._schedule = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.UtilService}\n         */\n        this._util = null;\n\n        /**\n         * @protected\n         * @type {?HieroProto.proto.AddressBookService}\n         */\n        this._addressBook = null;\n    }\n\n    /**\n     * @abstract\n     * @returns {void}\n     */\n    close() {\n        throw new Error(\"not implemented\");\n    }\n\n    /**\n     * @returns {HieroProto.proto.CryptoService}\n     */\n    get crypto() {\n        if (this._crypto != null) {\n            return this._crypto;\n        }\n\n        this._crypto = proto.CryptoService.create(\n            this._createUnaryClient(\"CryptoService\"),\n        );\n\n        return this._crypto;\n    }\n\n    /**\n     * @returns {HieroProto.proto.SmartContractService}\n     */\n    get smartContract() {\n        if (this._smartContract != null) {\n            return this._smartContract;\n        }\n\n        this._smartContract = proto.SmartContractService.create(\n            this._createUnaryClient(\"SmartContractService\"),\n        );\n\n        return this._smartContract;\n    }\n\n    /**\n     * @returns {HieroProto.proto.FileService}\n     */\n    get file() {\n        if (this._file != null) {\n            return this._file;\n        }\n\n        this._file = proto.FileService.create(\n            this._createUnaryClient(\"FileService\"),\n        );\n\n        return this._file;\n    }\n\n    /**\n     * @returns {HieroProto.proto.ConsensusService}\n     */\n    get consensus() {\n        if (this._consensus != null) {\n            return this._consensus;\n        }\n\n        this._consensus = proto.ConsensusService.create(\n            this._createUnaryClient(\"ConsensusService\"),\n        );\n\n        return this._consensus;\n    }\n\n    /**\n     * @returns {HieroProto.proto.FreezeService}\n     */\n    get freeze() {\n        if (this._freeze != null) {\n            return this._freeze;\n        }\n\n        this._freeze = proto.FreezeService.create(\n            this._createUnaryClient(\"FreezeService\"),\n        );\n\n        return this._freeze;\n    }\n\n    /**\n     * @returns {HieroProto.proto.NetworkService}\n     */\n    get network() {\n        if (this._network != null) {\n            return this._network;\n        }\n\n        this._network = proto.NetworkService.create(\n            this._createUnaryClient(\"NetworkService\"),\n        );\n\n        return this._network;\n    }\n\n    /**\n     * @returns {HieroProto.proto.TokenService}\n     */\n    get token() {\n        if (this._token != null) {\n            return this._token;\n        }\n\n        this._token = proto.TokenService.create(\n            this._createUnaryClient(\"TokenService\"),\n        );\n\n        return this._token;\n    }\n\n    /**\n     * @returns {HieroProto.proto.ScheduleService}\n     */\n    get schedule() {\n        if (this._schedule != null) {\n            return this._schedule;\n        }\n\n        this._schedule = proto.ScheduleService.create(\n            this._createUnaryClient(\"ScheduleService\"),\n        );\n\n        return this._schedule;\n    }\n\n    /**\n     * @returns {HieroProto.proto.UtilService}\n     */\n    get util() {\n        if (this._util != null) {\n            return this._util;\n        }\n\n        this._util = proto.UtilService.create(\n            this._createUnaryClient(\"UtilService\"),\n        );\n\n        return this._util;\n    }\n\n    /**\n     * @returns {HieroProto.proto.AddressBookService}\n     */\n    get addressBook() {\n        if (this._addressBook != null) {\n            return this._addressBook;\n        }\n\n        this._addressBook = proto.AddressBookService.create(\n            this._createUnaryClient(\"AddressBookService\"),\n        );\n\n        return this._addressBook;\n    }\n\n    /**\n     * @abstract\n     * @protected\n     * @param {string} serviceName\n     * @returns {import(\"protobufjs\").RPCImpl}\n     */\n    // eslint-disable-next-line @typescript-eslint/no-unused-vars\n    _createUnaryClient(serviceName) {\n        throw new Error(\"not implemented\");\n    }\n}\n\n// grpc-web+proto is a series of data or trailer frames\n\n// a frame is identified by a single byte (0 = data or 1 = trailer) followed by 4 bytes for the\n// length of the frame, followed by the frame data\n\n/**\n * @param {Uint8Array} data\n * @returns {ArrayBuffer}\n */\nexport function encodeRequest(data) {\n    // for our requests, we want to transfer a single data frame\n\n    const frame = new ArrayBuffer(data.byteLength + 5);\n\n    // the frame type (data) is zero and can be left default-initialized\n\n    // the length of the frame data\n    new DataView(frame, 1, 4).setUint32(0, data.length);\n\n    // copy in the frame data\n    new Uint8Array(frame, 5).set(data);\n\n    return frame;\n}\n\n/**\n * @param {ArrayBuffer} data\n * @param {number} byteOffset\n * @param {number} byteLength\n * @returns {Uint8Array}\n */\nexport function decodeUnaryResponse(\n    data,\n    byteOffset = 0,\n    byteLength = data.byteLength,\n) {\n    const dataView = new DataView(data, byteOffset, byteLength);\n    let dataOffset = 0;\n\n    /** @type {?Uint8Array} */\n    let unaryResponse = null;\n\n    // 0 = successful\n    let status = 0;\n\n    while (dataOffset < dataView.byteLength) {\n        const frameByte = dataView.getUint8(dataOffset + 0);\n        const frameType = frameByte >> 7;\n        const frameByteLength = dataView.getUint32(dataOffset + 1);\n        const frameOffset = dataOffset + 5; // offset from the start of the dataView\n        if (frameOffset + frameByteLength > dataView.byteLength) {\n            throw new Error(\"(BUG) unexpected frame length past the boundary\");\n        }\n        const frameData = new Uint8Array(\n            data,\n            dataView.byteOffset + frameOffset,\n            frameByteLength,\n        );\n\n        if (frameType === 0) {\n            if (unaryResponse != null) {\n                throw new Error(\n                    \"(BUG) unexpectedly received more than one data frame\",\n                );\n            }\n\n            unaryResponse = frameData;\n        } else if (frameType === 1) {\n            const trailer = utf8.decode(frameData);\n            const [trailerName, trailerValue] = trailer.split(\":\");\n\n            if (trailerName === \"grpc-status\") {\n                status = parseInt(trailerValue);\n            } else {\n                throw new Error(`(BUG) unhandled trailer, ${trailer}`);\n            }\n        } else {\n            throw new Error(`(BUG) unexpected frame type: ${frameType}`);\n        }\n\n        dataOffset += frameByteLength + 5;\n    }\n\n    if (status !== 0) {\n        throw new Error(`(BUG) unhandled grpc-status: ${status}`);\n    }\n\n    if (unaryResponse == null) {\n        throw new Error(\"(BUG) unexpectedly received no response\");\n    }\n\n    return unaryResponse;\n}\n"],"names":["proto","HieroProto","Channel","constructor","this","_crypto","_smartContract","_file","_consensus","_freeze","_network","_token","_schedule","_util","_addressBook","close","Error","crypto","CryptoService","create","_createUnaryClient","smartContract","SmartContractService","file","FileService","consensus","ConsensusService","freeze","FreezeService","network","NetworkService","token","TokenService","schedule","ScheduleService","util","UtilService","addressBook","AddressBookService","serviceName","encodeRequest","data","frame","ArrayBuffer","byteLength","DataView","setUint32","length","Uint8Array","set","decodeUnaryResponse","byteOffset","dataView","dataOffset","unaryResponse","status","frameType","getUint8","frameByteLength","getUint32","frameOffset","frameData","trailer","utf8.decode","trailerName","trailerValue","split","parseInt"],"mappings":"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"}